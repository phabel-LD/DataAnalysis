---
title: "ISSSTE_CeledonMurilloRicardo"
author: "Phabel López"
date: "2025-08-01"
output:
  word_document: default
  html_document: default
---

```{r echo=FALSE}
# Libraries
library(readxl)
library(psych)
library(Hmisc)
library(stringr)
library(dplyr)
library(tidyr)
library(webshot2)

library(ggpubr)
library(rstatix)
library(gtsummary)
library(gt)

library(ggplot2)
library(plotly)
library(car)
library(babynames)
library(gapminder)
```

# Celedon Murillo Ricardo

## 1) Preprocesamiento

### 1.1) Obtener y revisar datos originales

```{r echo=FALSE}
data <- data.frame(read_excel("Data.xlsx"))
data$Grupo[data$Grupo == "a"] <- "A"
data$Grupo[data$Grupo == "b"] <- "B"
#data
```

## 1.2) Procesar archivo archivo y hacer correcciones

### 1.3 Dividir en Grupos

```{r echo=FALSE}
# Grupo 1
group_1 <- data[data$Grupo == "A",]
group_1
```

```{r echo=FALSE}
# Grupo 2
group_2 <- data[data$Grupo == "B",]
group_2
```

```{r echo=FALSE, fig.height=8, fig.width=10}
# Group
data_summary <- data %>%
  group_by(Grupo) %>%
  summarise(n = n(), .groups = 'drop')

# Stacked barplot
p <- ggplot(data_summary, aes(x = Grupo, y = n, fill = Grupo)) +
  geom_bar(stat = "identity", position = "stack", colour = "black", lwd = 0.5) +
  labs(title = "Proporciones de Grupos",
       fill = "Grupo",
       x = NULL,
       y = "Frequencia") +
  theme_minimal()
p
#ggplotly(p)
```

## 2) Estadística Descriptiva por Grupo

```{r echo=FALSE, fig.height=8, fig.width=10, results='asis'}
# P-values
pvals <- c(NA, NA, NA, 0.36, NA, 4.19e-05, 0.56, 1.64e-04, 7.56e-04, 6.71e-04, NA, NA, 1.0, 1.0, 1.55e-03, 2.94e-04, 1.25e-05, 1.25e-05, 0.637, 0.54, 8.18e-04, 0.00135, 0.54, 0.62)

# Var names
vars <- colnames(data)

# Vars - Pvalues df
pvals_df <- data.frame(
  variable = vars,
  p_value = pvals,
  stringsAsFactors = FALSE
)

# Add Adj_Pval to labels
labels_with_p <- sapply(1:nrow(pvals_df), function(i) {
  p <- pvals_df$p_value[i]
  if (is.na(p)) {
    pvals_df$variable[i]
  } else {
    paste0(pvals_df$variable[i], " (Adj_Pval = ", format(p, digits=4), ")")
  }
})

# setNames list of Vars-Pvals
label_list <- setNames(as.list(labels_with_p), vars)

table_1 <- data |>
  tbl_summary(
    by = Grupo,
    label = label_list,
    type = all_continuous() ~ "continuous2",
    statistic = list(
      all_continuous() ~ c(
        "{N_nonmiss}",
        "mean (SD)" = "{mean} ({sd})",
        "median (p25, p75)" = "{median} ({p25}, {p75})",
        "Min - Max" = "{min} - {max}"
      )
    ),
    missing = "no"
  ) |>
  add_overall() |>
  add_n() |>
  bold_labels()#|>
  #add_p()  # Esto agrega la columna con p-valores
```

```{r echo=FALSE, fig.height=8, fig.width=10, results='asis'}
# Word
#as_kable(table_1)

# HTML
as_raw_html(as_gt(table_1))
```

### 2.1) Descripción Global para Grupo A

Medidas de Tendencia Central para Variables Numéricas Grupo A

```{r echo=FALSE}
psych::describe(group_1[sapply(group_1, class) == 'numeric'])
```

Frequencias detalladas de variables numéricas

```{r echo=FALSE}
Hmisc::describe(group_1[sapply(group_1, class) == 'numeric'])
```

### 2.2) Descripción Global para Grupo B

Medidas de Tendencia Central para Variables Numéricas Grupo 2: GRUPO B LIDOCAINA PERFUSION

```{r echo=FALSE}
psych::describe(group_2[sapply(group_2, class) == 'numeric'])
```

Frequencias detalladas de variables numéricas

```{r echo=FALSE}
Hmisc::describe(group_2[sapply(group_2, class) == 'numeric'])
```

### 2.3) Edad

Plot de Violín por Grupo
```{r echo=FALSE, fig.height=8, fig.width=10}
p <- ggplot(data, aes(x=Grupo, y=Edad, color=Grupo)) + 
    geom_violin(trim=FALSE, alpha=0.5) +
    geom_jitter(shape=16, position=position_jitter(0.1)) +
    geom_boxplot(width=0.1) +
    labs(fill = "Grupo",
       x="Grupo",
       y="Edad",
       title="Violin Plots de Edad por Grupo") +
    theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

Histograma por Grupos
```{r echo=FALSE, fig.height=8, fig.width=10}
# Histogram
p <- ggplot(data, aes(x = Edad, fill = factor(Grupo))) +
  geom_histogram(colour = "black",
                 lwd = 0.75,
                 linetype = 1,
                 position = "identity",
                 binwidth = 5,
                 alpha = 0.5) +
  labs(fill = "Grupo",
       x="Edad",
       y="Frequencia",
       title="Histograma de Edad por Grupo") +
  theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

### 2.4) Peso (kg)

Plot de Violín por Grupo
```{r echo=FALSE, fig.height=8, fig.width=10}
p <- ggplot(data, aes(x=Grupo, y=Peso, color=Grupo)) + 
    geom_violin(trim=FALSE, alpha=0.5) +
    geom_jitter(shape=16, position=position_jitter(0.1)) +
    geom_boxplot(width=0.1) +
    labs(fill = "Grupo",
       x="Grupo",
       y="Peso (kg)",
       title="Violin Plots de Peso (kg) por Grupo") +
    theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

Histograma por Grupos
```{r echo=FALSE, fig.height=8, fig.width=10}
# Histogram
p <- ggplot(data, aes(x = Peso, fill = factor(Grupo))) +
  geom_histogram(colour = "black",
                 lwd = 0.75,
                 linetype = 1,
                 position = "identity",
                 binwidth = 5,
                 alpha = 0.5) +
  labs(fill = "Grupo",
       x="Peso (kg)",
       y="Frequencia",
       title="Histograma de Peso (kg) por Grupo") +
  theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

### 2.5) ASA

Gráficas de Barras Agrupadas por Grupo.
```{r echo=FALSE, fig.height=8, fig.width=10}
# Group
data_summary <- data %>%
  group_by(Grupo, ASA) %>%
  summarise(n = n(), .groups = 'drop')

# Plot
p <- ggplot(data_summary, aes(x = Grupo, y = n, fill = ASA)) +
  geom_bar(stat = "identity", position = position_dodge(), colour = "black", lwd = 0.5) +
  geom_text(aes(x = Grupo, y = n + 0.25, label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.25) +
  labs(title = "Proporciones de ASA por Grupo",
       fill = "ASA",
       x = NULL,
       y = "Frequencia") +
  theme_minimal()
p
#ggplotly(p)
```

Gráficas de Pie con Pruebas de X2
```{r echo=FALSE, fig.height=6, fig.width=10}
# Categorical Test
p <- ggstatsplot::ggpiestats(
    data = data,
    x = ASA,
    y = Grupo,
    type = "nonparametric",
    title = "Proporciones de ASA por Grupo",
    pairwise.display = "significant",
    p.adjust.method = "holm"
)
p
```

### 2.6) Talla (m)

Plot de Violín por Grupo
```{r echo=FALSE, fig.height=8, fig.width=10}
p <- ggplot(data, aes(x=Grupo, y=Talla, color=Grupo)) + 
    geom_violin(trim=FALSE, alpha=0.5) +
    geom_jitter(shape=16, position=position_jitter(0.1)) +
    geom_boxplot(width=0.1) +
    labs(fill = "Grupo",
       x="Grupo",
       y="Talla (m)",
       title="Violin Plots de Talla (m) por Grupo") +
    theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

Histograma por Grupos
```{r echo=FALSE, fig.height=8, fig.width=10}
# Histogram
p <- ggplot(data, aes(x = Talla, fill = factor(Grupo))) +
  geom_histogram(colour = "black",
                 lwd = 0.75,
                 linetype = 1,
                 position = "identity",
                 binwidth = 0.05,
                 alpha = 0.5) +
  labs(fill = "Grupo",
       x="Talla (m)",
       y="Frequencia",
       title="Histograma de Talla (m) por Grupo") +
  theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

### 2.7) Tiempo de Bloqueo (min)

Plot de Violín por Grupo
```{r echo=FALSE, fig.height=8, fig.width=10}
p <- ggplot(data, aes(x=Grupo, y=Tiempo_Bloqueo_min, color=Grupo)) + 
    geom_violin(trim=FALSE, alpha=0.5) +
    geom_jitter(shape=16, position=position_jitter(0.1)) +
    geom_boxplot(width=0.1) +
    labs(fill = "Grupo",
       x="Grupo",
       y="Tiempo de Bloqueo (min)",
       title="Violin Plots de Tiempo de Bloqueo (min) por Grupo") +
    theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

Histograma por Grupos
```{r echo=FALSE, fig.height=8, fig.width=10}
# Histogram
p <- ggplot(data, aes(x = Tiempo_Bloqueo_min, fill = factor(Grupo))) +
  geom_histogram(colour = "black",
                 lwd = 0.75,
                 linetype = 1,
                 position = "identity",
                 binwidth = 1,
                 alpha = 0.5) +
  labs(fill = "Grupo",
       x="Tiempo de Bloqueo (min)",
       y="Frequencia",
       title="Histograma de Tiempo de Bloqueo (min) por Grupo") +
  theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

### 2.8) RAAS [T1-Término]

Plots de Violin Agrupados por Tiempos
```{r echo=FALSE, fig.height=6, fig.width=8}
# Convert wide to long format
data_long <- data %>%
  pivot_longer(
    cols = starts_with("RAAS"),
    names_to = "Tiempo",
    values_to = "Valor"
  )

# Loop through each Tiempo and generate individual plots
for (tiempo in unique(data_long$Tiempo)) {
  subset_data <- filter(data_long, Tiempo == tiempo)
  
  p <- ggstatsplot::ggpiestats(
    data = subset_data,
    x = Valor,
    y = Grupo,
    type = "nonparametric",
    title = tiempo,
    pairwise.display = "significant",
    p.adjust.method = "holm"
  )
  print(p)
  
}
```

### 2.9) BROOMAGE [T1-Término]

Plots de Violin Agrupados por Tiempos
```{r echo=FALSE, fig.height=6, fig.width=8}
# Convert wide to long format
data_long <- data %>%
  pivot_longer(
    cols = starts_with("BROOMAGE"),
    names_to = "Tiempo",
    values_to = "Valor"
  )

# Loop through each Tiempo and generate individual plots
for (tiempo in unique(data_long$Tiempo)) {
  subset_data <- filter(data_long, Tiempo == tiempo)
  
  p <- ggstatsplot::ggpiestats(
    data = subset_data,
    x = Valor,
    y = Grupo,
    type = "nonparametric",
    title = tiempo,
    pairwise.display = "significant",
    p.adjust.method = "holm"
  )
  print(p)
  
}
```

### 2.10) Metamera [T1-Término]

Plots de Violin Agrupados por Tiempos
```{r echo=FALSE, fig.height=6, fig.width=8}
# Convert wide to long format
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Metamera"),
    names_to = "Tiempo",
    values_to = "Valor"
  )

# Loop through each Tiempo and generate individual plots
for (tiempo in unique(data_long$Tiempo)) {
  subset_data <- filter(data_long, Tiempo == tiempo)
  
  p <- ggstatsplot::ggpiestats(
    data = subset_data,
    x = Valor,
    y = Grupo,
    type = "nonparametric",
    title = tiempo,
    pairwise.display = "significant",
    p.adjust.method = "holm"
  )
  print(p)
  
}
```

### 2.11) Total de Tiempo de Procedmiento Anestésico (min)

Plot de Violín por Grupo
```{r echo=FALSE, fig.height=8, fig.width=10}
p <- ggplot(data, aes(x=Grupo, y=Total_Tiempo_Procedimiento_Anestesico_min, color=Grupo)) + 
    geom_violin(trim=FALSE, alpha=0.5) +
    geom_jitter(shape=16, position=position_jitter(0.1)) +
    geom_boxplot(width=0.1) +
    labs(fill = "Grupo",
       x="Grupo",
       y="Tiempo (min)",
       title="Violin Plots de Total de Tiempo de Procedmiento Anestésico (min) por Grupo") +
    theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

Histograma por Grupos
```{r echo=FALSE, fig.height=8, fig.width=10}
# Histogram
p <- ggplot(data, aes(x = Total_Tiempo_Procedimiento_Anestesico_min, fill = factor(Grupo))) +
  geom_histogram(colour = "black",
                 lwd = 0.75,
                 linetype = 1,
                 position = "identity",
                 binwidth = 20,
                 alpha = 0.5) +
  labs(fill = "Grupo",
       x="Tiempo (min)",
       y="Frequencia",
       title="Histograma de Total de Tiempo de Procedmiento Anestésico (min) por Grupo") +
  theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

### 2.12) Presencia de Náusea o Vómito

Gráficas de Barras Agrupadas por Grupo.
```{r echo=FALSE, fig.height=8, fig.width=10}
# Group
data_summary <- data %>%
  group_by(Grupo, Nausea_Vomito) %>%
  summarise(n = n(), .groups = 'drop')

# Plot
p <- ggplot(data_summary, aes(x = Grupo, y = n, fill = Nausea_Vomito)) +
  geom_bar(stat = "identity", position = position_dodge(), colour = "black", lwd = 0.5) +
  geom_text(aes(x = Grupo, y = n + 0.25, label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.25) +
  labs(title = "Proporciones de Náusea o Vómito por Grupo",
       fill = "Náusea o Vómito",
       x = NULL,
       y = "Frequencia") +
  theme_minimal()
p
#ggplotly(p)
```

Gráficas de Pie con Pruebas de X2
```{r echo=FALSE, fig.height=6, fig.width=10}
# Categorical Test
p <- ggstatsplot::ggpiestats(
    data = data,
    x = Nausea_Vomito,
    y = Grupo,
    type = "nonparametric",
    title = "Proporciones de Náusea o Vómito por Grupo",
    pairwise.display = "significant",
    p.adjust.method = "holm"
)
p
```

### 2.13) Uso de Anestesia Peridural

Gráficas de Barras Agrupadas por Grupo.
```{r echo=FALSE, fig.height=8, fig.width=10}
# Group
data_summary <- data %>%
  group_by(Grupo, Anestesia_Peridural) %>%
  summarise(n = n(), .groups = 'drop')

# Plot
p <- ggplot(data_summary, aes(x = Grupo, y = n, fill = Anestesia_Peridural)) +
  geom_bar(stat = "identity", position = position_dodge(), colour = "black", lwd = 0.5) +
  geom_text(aes(x = Grupo, y = n + 0.25, label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.25) +
  labs(title = "Proporciones de Uso de Anestesia Peridural por Grupo",
       fill = "Uso de Anestesia Peridural",
       x = NULL,
       y = "Frequencia") +
  theme_minimal()
p
#ggplotly(p)
```

Gráficas de Pie con Pruebas de X2
```{r echo=FALSE, fig.height=6, fig.width=10}
# Categorical Test
p <- ggstatsplot::ggpiestats(
    data = data,
    x = Anestesia_Peridural,
    y = Grupo,
    type = "nonparametric",
    title = "Proporciones de Uso de Anestesia Peridural por Grupo",
    pairwise.display = "significant",
    p.adjust.method = "holm"
)
p
```

### 2.14) Dosis Total de Ropivacaína Peridural (mg)

Plot de Violín por Grupo
```{r echo=FALSE, fig.height=8, fig.width=10}
p <- ggplot(data, aes(x=Grupo, y=Dosis_Ropivacaina_Peridural_mg, color=Grupo)) + 
    geom_violin(trim=FALSE, alpha=0.5) +
    geom_jitter(shape=16, position=position_jitter(0.1)) +
    geom_boxplot(width=0.1) +
    labs(fill = "Grupo",
       x="Grupo",
       y="Dosis Total (mg)",
       title="Violin Plots de Dosis Total de Ropivacaína Peridural (mg) por Grupo") +
    theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

Histograma por Grupos
```{r echo=FALSE, fig.height=8, fig.width=10}
# Histogram
p <- ggplot(data, aes(x = Dosis_Ropivacaina_Peridural_mg, fill = factor(Grupo))) +
  geom_histogram(colour = "black",
                 lwd = 0.75,
                 linetype = 1,
                 position = "identity",
                 binwidth = 10,
                 alpha = 0.5) +
  labs(fill = "Grupo",
       x="Dosis Total (mg)",
       y="Frequencia",
       title="Histograma de Dosis Total de Ropivacaína Peridural (mg) por Grupo") +
  theme(plot.title = element_text(size=12))
p
#ggplotly(p)
```

### 2.15) Bradicardia

Gráficas de Barras Agrupadas por Grupo.
```{r echo=FALSE, fig.height=8, fig.width=10}
# Group
data_summary <- data %>%
  group_by(Grupo, Bradicardia) %>%
  summarise(n = n(), .groups = 'drop')

# Plot
p <- ggplot(data_summary, aes(x = Grupo, y = n, fill = Bradicardia)) +
  geom_bar(stat = "identity", position = position_dodge(), colour = "black", lwd = 0.5) +
  geom_text(aes(x = Grupo, y = n + 0.25, label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.25) +
  labs(title = "Proporciones de Bradicardia por Grupo",
       fill = "Bradicardia",
       x = NULL,
       y = "Frequencia") +
  theme_minimal()
p
#ggplotly(p)
```

Gráficas de Pie con Pruebas de X2
```{r echo=FALSE, fig.height=6, fig.width=10}
# Categorical Test
p <- ggstatsplot::ggpiestats(
    data = data,
    x = Bradicardia,
    y = Grupo,
    type = "nonparametric",
    title = "Proporciones de Bradicardia por Grupo",
    pairwise.display = "significant",
    p.adjust.method = "holm"
)
p
```

### 2.16) Hipotensión

Gráficas de Barras Agrupadas por Grupo.
```{r echo=FALSE, fig.height=8, fig.width=10}
# Group
data_summary <- data %>%
  group_by(Grupo, Hipotension) %>%
  summarise(n = n(), .groups = 'drop')

# Plot
p <- ggplot(data_summary, aes(x = Grupo, y = n, fill = Hipotension)) +
  geom_bar(stat = "identity", position = position_dodge(), colour = "black", lwd = 0.5) +
  geom_text(aes(x = Grupo, y = n + 0.25, label = n),
            position = position_dodge(width = 0.9),
            vjust = -0.25) +
  labs(title = "Proporciones de Hipotensión por Grupo",
       fill = "Hipotensión",
       x = NULL,
       y = "Frequencia") +
  theme_minimal()
p
#ggplotly(p)
```

Gráficas de Pie con Pruebas de X2
```{r echo=FALSE, fig.height=6, fig.width=10}
# Categorical Test
p <- ggstatsplot::ggpiestats(
    data = data,
    x = Hipotension,
    y = Grupo,
    type = "nonparametric",
    title = "Proporciones de Hipotensión por Grupo",
    pairwise.display = "significant",
    p.adjust.method = "holm"
)
p
```

## 3) Estadística Inferencial: Prubas de Hipótesis

### 3.1) Tests pareados de U-Mann-Whitney (t-test de dos lados no paramétrico).

#### 3.1.1) Tiempo de Bloqueo (min)

```{r echo=FALSE, fig.height=6, fig.width=10}

p <- ggstatsplot::ggbetweenstats(
    data = data,
    x = Grupo,
    y = Tiempo_Bloqueo_min,
    type = "nonparametric",
    pairwise.display = "significant",
    p.adjust.method = "BH",
    digits = "signif",
    xlab = "Grupos",
    ylab = "Tiempo de Bloqueo (min)",
    title = "Tiempo de Bloqueo (min)"
)
p
```

#### 3.1.2) Tiempo Total de Procedimiento Anestésico (min)

```{r echo=FALSE, fig.height=6, fig.width=10}

p <- ggstatsplot::ggbetweenstats(
    data = data,
    x = Grupo,
    y = Total_Tiempo_Procedimiento_Anestesico_min,
    type = "nonparametric",
    pairwise.display = "significant",
    p.adjust.method = "BH",
    digits = "signif",
    xlab = "Grupos",
    ylab = "Tiempo Total (min)",
    title = "Tiempo Total de Procedimiento Anestésico (min)"
)
p
```

#### 3.1.3) Dosis Total de Ropivacaína (mg)

```{r echo=FALSE, fig.height=6, fig.width=10}

p <- ggstatsplot::ggbetweenstats(
    data = data,
    x = Grupo,
    y = Dosis_Ropivacaina_Peridural_mg,
    type = "nonparametric",
    pairwise.display = "significant",
    p.adjust.method = "BH",
    digits = "signif",
    xlab = "Grupos",
    ylab = "Dosis (mg)",
    title = "Dosis Total de Ropivacaína (mg)"
)
p
```


